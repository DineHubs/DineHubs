@if (isOpen) {
  <div
      class="fixed inset-0 z-40 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in"
    (click)="onBackdropClick($event)"
    role="dialog"
    aria-modal="true"
    aria-labelledby="checkout-modal-title">
    
    <div
      #modalContent
        class="w-full max-w-md md:max-w-lg bg-surface-light dark:bg-surface-dark rounded-2xl shadow-2xl animate-in zoom-in-95 duration-200 max-h-[90vh] overflow-hidden flex flex-col z-50"
      (click)="$event.stopPropagation()"
      tabindex="-1">
      
      <!-- Header -->
      <div class="flex items-center justify-between p-6 border-b border-border-light dark:border-border-dark">
        <h2 id="checkout-modal-title" class="text-xl md:text-2xl font-bold leading-tight text-text-primary-light dark:text-text-primary-dark">
          Checkout
        </h2>
        <button
          type="button"
          class="p-2 rounded-xl hover:bg-border-light dark:hover:bg-border-dark transition-all duration-200 active:scale-95"
          (click)="close()"
          [attr.aria-label]="'Close checkout modal'">
          <lucide-icon [name]="xIcon" size="24"></lucide-icon>
        </button>
      </div>

      <!-- Content -->
      <div class="flex-1 overflow-y-auto p-6 space-y-6">
        <!-- Order Total -->
        <div class="p-4 rounded-xl bg-primary/10 dark:bg-primary/20 border border-primary/20">
          <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark mb-1">
            Order Total
          </p>
          <p class="text-3xl font-bold text-primary">
            RM{{ orderTotal | number:'1.2-2' }}
          </p>
        </div>

        <!-- Payment Provider Selection -->
        <div>
          <label class="block text-sm font-medium text-text-primary-light dark:text-text-primary-dark mb-3">
            Payment Method
          </label>
          <div class="grid grid-cols-3 gap-3">
            @for (provider of paymentProviders; track provider) {
              <button
                type="button"
                [ngClass]="{
                  'border-primary bg-primary/10 dark:bg-primary/20': selectedProvider() === provider,
                  'border-border-light dark:border-border-dark hover:border-primary/50': selectedProvider() !== provider
                }"
                class="p-4 rounded-xl border-2 transition-all duration-200 active:scale-95"
                (click)="onProviderSelect(provider)"
                [attr.aria-pressed]="selectedProvider() === provider">
                <div class="flex flex-col items-center gap-2">
                  <lucide-icon [name]="getProviderIcon(provider)" size="24" class="text-primary"></lucide-icon>
                  <span class="text-xs font-medium text-text-primary-light dark:text-text-primary-dark">
                    {{ getProviderLabel(provider) }}
                  </span>
                </div>
              </button>
            }
          </div>
        </div>

        <!-- Amount Input -->
        <div>
          <label class="block text-sm font-medium text-text-primary-light dark:text-text-primary-dark mb-2">
            Amount
          </label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-secondary-light dark:text-text-secondary-dark">
              RM
            </span>
            <input
              type="number"
              [value]="amount()"
              (input)="onAmountChange($any($event.target).value)"
              [max]="orderTotal"
              min="0.01"
              step="0.01"
              class="w-full pl-8 pr-4 py-3 rounded-xl bg-bg-light dark:bg-bg-dark border border-border-light dark:border-border-dark text-text-primary-light dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-200"
              placeholder="0.00">
          </div>
          <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-1">
            Maximum: RM{{ orderTotal | number:'1.2-2' }}
          </p>
        </div>
      </div>

      <!-- Footer -->
      <div class="p-6 border-t border-border-light dark:border-border-dark">
        <button
          type="button"
          class="w-full px-6 py-4 rounded-xl bg-primary hover:bg-primary/90 text-white font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center shadow-md hover:shadow-lg"
          (click)="processPayment()"
          [disabled]="isSubmitting || amount() <= 0 || amount() > orderTotal">
          @if (isSubmitting) {
            <div class="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"></div>
            <span>Processing Payment...</span>
          } @else {
            <lucide-icon [name]="creditCardIcon" size="20" class="inline-block mr-2"></lucide-icon>
            <span>Process Payment</span>
          }
        </button>
      </div>
    </div>
  </div>
}

