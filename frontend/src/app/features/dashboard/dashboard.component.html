<div class="p-4 md:p-6 space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
    <h1 class="text-2xl md:text-3xl font-bold leading-tight text-text-primary-light dark:text-text-primary-dark">Dashboard</h1>
    
    <div class="flex flex-wrap items-center gap-3">
      <!-- Branch Selector (Admin and Manager only) -->
      @if ((isAdmin || isManager) && branches().length > 0) {
        <select
          [value]="selectedBranchId() || ''"
          (change)="onBranchChange($any($event.target).value)"
          [disabled]="branchesLoading()"
          class="px-4 py-3 rounded-xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-primary-light dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-200 disabled:opacity-50">
          <option value="">All Branches</option>
          @for (branch of branches(); track branch.id) {
            <option [value]="branch.id">{{ branch.name }}</option>
          }
        </select>
      }

      <!-- Period Selector -->
      <select
        [value]="selectedPeriod()"
        (change)="onPeriodChange($any($event.target).value)"
        class="px-4 py-3 rounded-xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-primary-light dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-200">
        <option value="today">Today</option>
        <option value="week">Last 7 Days</option>
        <option value="month">This Month</option>
        <option value="year">This Year</option>
      </select>
      
      <button
        type="button"
        class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-border-light dark:hover:bg-border-dark transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
        (click)="loadDashboardData()"
        [disabled]="isLoading()"
        [attr.aria-label]="'Refresh dashboard'">
        <lucide-icon [name]="refreshIcon" size="20" class="text-text-primary-light dark:text-text-primary-dark" [class.animate-spin]="isLoading()"></lucide-icon>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading() && !stats) {
    <div class="flex flex-col items-center justify-center py-24">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mb-4"></div>
      <p class="text-text-secondary-light dark:text-text-secondary-dark">Loading dashboard data...</p>
    </div>
  }

  <!-- Error State -->
  @else if (hasError() && !stats) {
    <div class="flex flex-col items-center justify-center py-24 text-center">
      <div class="p-4 rounded-full bg-error/10 mb-4">
        <lucide-icon [name]="alertCircleIcon" size="48" class="text-error"></lucide-icon>
      </div>
      <h2 class="text-xl md:text-2xl font-bold leading-tight text-text-primary-light dark:text-text-primary-dark mb-2">Unable to Load Dashboard</h2>
      <p class="text-sm md:text-base text-text-secondary-light dark:text-text-secondary-dark mb-6 leading-relaxed">{{ errorMessage() }}</p>
      <button
        type="button"
        class="px-6 py-3 rounded-xl bg-primary hover:bg-primary/90 text-white font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-md hover:shadow-lg"
        (click)="loadDashboardData()">
        <lucide-icon [name]="refreshIcon" size="20"></lucide-icon>
        <span>Retry</span>
      </button>
    </div>
  }

  <!-- Dashboard Content -->
  @else {
    <!-- Empty State -->
    @if (isEmpty) {
      <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-lg p-8 md:p-12">
        <div class="flex flex-col items-center justify-center text-center space-y-6">
          <div class="p-6 rounded-full bg-primary/10 dark:bg-primary/20">
            <lucide-icon [name]="dashboardIcon" size="64" class="text-primary"></lucide-icon>
          </div>
          <div class="space-y-2">
            <h2 class="text-xl md:text-2xl font-bold leading-tight text-text-primary-light dark:text-text-primary-dark">Welcome to Your Dashboard!</h2>
            <p class="text-sm md:text-base text-text-secondary-light dark:text-text-secondary-dark max-w-md leading-relaxed">
              Your dashboard is empty because you haven't created any orders yet.
            </p>
          </div>
          <div class="space-y-4 w-full max-w-md">
            <p class="text-sm font-semibold text-text-primary-light dark:text-text-primary-dark">Get started by:</p>
            <ul class="space-y-3 text-left">
              @if (isManager || isAdmin) {
                <li class="flex items-center gap-3 text-text-secondary-light dark:text-text-secondary-dark">
                  <lucide-icon [name]="utensilsIcon" size="20" class="text-primary"></lucide-icon>
                  <span>Add menu items to your catalog</span>
                </li>
              }
              @if (isManager || isWaiter) {
                <li class="flex items-center gap-3 text-text-secondary-light dark:text-text-secondary-dark">
                  <lucide-icon [name]="shoppingCartIcon" size="20" class="text-primary"></lucide-icon>
                  <span>Create your first order</span>
                </li>
              }
              @if (isAdmin || isSuperAdmin) {
                <li class="flex items-center gap-3 text-text-secondary-light dark:text-text-secondary-dark">
                  <lucide-icon [name]="usersIcon" size="20" class="text-primary"></lucide-icon>
                  <span>Add users to your team</span>
                </li>
              }
              @if (isAdmin || isSuperAdmin) {
                <li class="flex items-center gap-3 text-text-secondary-light dark:text-text-secondary-dark">
                  <lucide-icon [name]="buildingIcon" size="20" class="text-primary"></lucide-icon>
                  <span>Set up additional branches</span>
                </li>
              }
            </ul>
          </div>
          <div class="flex flex-wrap gap-3 justify-center">
            @if (isManager || isWaiter) {
              <a
                routerLink="/orders/create"
                class="px-6 py-3 rounded-xl bg-primary hover:bg-primary/90 text-white font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-md hover:shadow-lg">
                <lucide-icon [name]="shoppingCartIcon" size="20"></lucide-icon>
                <span>Create First Order</span>
              </a>
            }
            @if (isManager || isAdmin) {
              <a
                routerLink="/menu"
                class="px-6 py-3 rounded-xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-border-light dark:hover:bg-border-dark text-text-primary-light dark:text-text-primary-dark font-semibold transition-all active:scale-95 flex items-center gap-2">
                <lucide-icon [name]="utensilsIcon" size="20"></lucide-icon>
                <span>Manage Menu</span>
              </a>
            }
          </div>
        </div>
      </div>
    }

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      @for (stat of statCards; track stat.title) {
        <a
          [routerLink]="stat.route || null"
          [class.cursor-pointer]="stat.route"
          [class.cursor-default]="!stat.route"
          class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 p-6"
          [class.hover:scale-105]="stat.route">
          <div class="flex items-center gap-4">
            <div class="p-3 rounded-xl" [style.background-color]="stat.color + '20'">
              <lucide-icon [name]="getIconForStat(stat.icon)" size="24" [style.color]="stat.color"></lucide-icon>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-2xl font-bold text-text-primary-light dark:text-text-primary-dark mb-1 truncate">
                {{ stat.value }}
              </p>
              <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark truncate">
                {{ stat.title }}
              </p>
            </div>
          </div>
        </a>
      }
    </div>

    <!-- Charts Section -->
    @if (isManager || isAdmin) {
      <div class="space-y-6">
        <h2 class="text-xl md:text-2xl font-bold leading-tight text-text-primary-light dark:text-text-primary-dark">Analytics</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Sales Trend Chart -->
          @if (salesTrend && salesTrend.length > 0) {
            <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-lg p-6">
              <app-sales-trend-chart [data]="salesTrend" title="Sales Trend (Last 7 Days)"></app-sales-trend-chart>
            </div>
          }

          <!-- Orders by Status Pie Chart -->
          @if (statusChartData && statusChartData.length > 0) {
            <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-lg p-6">
              <app-pie-chart [data]="statusChartData" title="Orders by Status" [chartType]="'pie'"></app-pie-chart>
            </div>
          }

          <!-- Top Selling Items -->
          @if (topItemsChartData && topItemsChartData.length > 0) {
            <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-lg p-6">
              <app-bar-chart [data]="topItemsChartData" title="Top Selling Items" [orientation]="'horizontal'" [yAxisLabel]="'Quantity'"></app-bar-chart>
            </div>
          }

          <!-- Orders by Hour -->
          @if (hourlyChartData && hourlyChartData.length > 0) {
            <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-lg p-6">
              <app-bar-chart [data]="hourlyChartData" title="Orders by Hour (Today)" [orientation]="'vertical'"></app-bar-chart>
            </div>
          }
        </div>
      </div>
    }

    <!-- SuperAdmin Analytics -->
    @if (isSuperAdmin) {
      <div class="space-y-6">
        <h2 class="text-xl md:text-2xl font-bold leading-tight text-text-primary-light dark:text-text-primary-dark">Subscription Analytics</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Subscription Status Breakdown -->
          @if (subscriptionStatusData && subscriptionStatusData.length > 0) {
            <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-lg p-6">
              <app-pie-chart [data]="subscriptionStatusData" title="Subscription Status Breakdown" [chartType]="'pie'"></app-pie-chart>
            </div>
          }

          <!-- Subscription Trend -->
          @if (subscriptionTrendData && subscriptionTrendData.length > 0) {
            <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-lg p-6">
              <app-bar-chart [data]="subscriptionTrendData" title="Subscription Trend (Last 6 Months)" [orientation]="'vertical'" [yAxisLabel]="'New Subscriptions'"></app-bar-chart>
            </div>
          }
        </div>
      </div>
    }

    <!-- Kitchen Dashboard -->
    @if (isKitchen) {
      <div class="space-y-6">
        <h2 class="text-xl md:text-2xl font-bold leading-tight text-text-primary-light dark:text-text-primary-dark">Kitchen Analytics</h2>
        
        @if (statusChartData && statusChartData.length > 0) {
          <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-lg p-6">
            <app-pie-chart [data]="statusChartData" title="Orders by Status" [chartType]="'doughnut'"></app-pie-chart>
          </div>
        }
      </div>
    }

    <!-- Quick Actions -->
    <div class="space-y-4">
      <h2 class="text-xl md:text-2xl font-bold leading-tight text-text-primary-light dark:text-text-primary-dark">Quick Actions</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
        @if (isSuperAdmin) {
          <a
            routerLink="/tenants"
            class="px-6 py-4 rounded-xl bg-primary hover:bg-primary/90 text-white font-semibold transition-all active:scale-95 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
            <lucide-icon [name]="buildingIcon" size="20"></lucide-icon>
            <span>Tenant Management</span>
          </a>
          <a
            routerLink="/tenants"
            class="px-6 py-3 rounded-xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-border-light dark:hover:bg-border-dark text-text-primary-light dark:text-text-primary-dark font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <lucide-icon [name]="creditCardIcon" size="20"></lucide-icon>
            <span>Subscriptions</span>
          </a>
        }
        @if (isManager || isWaiter) {
          <a
            routerLink="/orders/create"
            class="px-6 py-4 rounded-xl bg-primary hover:bg-primary/90 text-white font-semibold transition-all active:scale-95 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
            <lucide-icon [name]="shoppingCartIcon" size="20"></lucide-icon>
            <span>New Order</span>
          </a>
        }
        @if (isManager || isAdmin) {
          <a
            routerLink="/menu"
            class="px-6 py-3 rounded-xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-border-light dark:hover:bg-border-dark text-text-primary-light dark:text-text-primary-dark font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <lucide-icon [name]="utensilsIcon" size="20"></lucide-icon>
            <span>Manage Menu</span>
          </a>
        }
        @if (isKitchen || isManager) {
          <a
            routerLink="/kitchen"
            class="px-6 py-3 rounded-xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-border-light dark:hover:bg-border-dark text-text-primary-light dark:text-text-primary-dark font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <lucide-icon [name]="chefHatIcon" size="20"></lucide-icon>
            <span>Kitchen Display</span>
          </a>
        }
        @if (!isSuperAdmin) {
          <a
            routerLink="/tables"
            class="px-6 py-3 rounded-xl bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-border-light dark:hover:bg-border-dark text-text-primary-light dark:text-text-primary-dark font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <lucide-icon [name]="tableIcon" size="20"></lucide-icon>
            <span>Table Management</span>
          </a>
        }
      </div>
    </div>
  }
</div>
